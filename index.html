<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Aflatoxin Calculator (Vanilla JS)</title>
  <style>
    body { font-family: Arial; background:#f5f5f5; padding:20px; }
    .card { background:#fff; padding:16px; border-radius:12px; margin-bottom:20px; box-shadow:0 2px 4px #0002; }
    input { padding:6px; width:100%; }
    table { border-collapse: collapse; width:100%; margin-top:10px; }
    td,th { border:1px solid #444; padding:6px; text-align:center; }
    .flex { display:flex; gap:8px; }
    .btn { padding:6px 10px; background:#1976d2; color:white; border:none; cursor:pointer; }
    .btn:hover { opacity:.8; }
  </style>
</head>
<body>
<h1>Aflatoxin HPLC Calculator — Vanilla JavaScript</h1>

<div id="app"></div>

<script>
// ---------------------------
// CONSTANTS
// ---------------------------
const TOXINS = ["B1", "B2", "G1", "G2"];

// DATA MODEL
let standards = {};
TOXINS.forEach(t => standards[t] = [
  { id: id(), conc: 0, area: "", rt: "" },
  { id: id(), conc: 1, area: "", rt: "" },
  { id: id(), conc: 5, area: "", rt: "" }
]);

let samples = [ { id: id(), name: "Sample A", peaks: [] } ];

let dilution = 1;
let sampleWeight = 5;
let rtTolerance = 0.2;

function id(){ return Date.now() + Math.random(); }

// ---------------------------
// CORE MATH FUNCTIONS
// ---------------------------
function linearRegression(points){
  if(points.length < 2) return null;
  let n = points.length;
  let sumX = points.reduce((a,b)=>a+b.x,0);
  let sumY = points.reduce((a,b)=>a+b.y,0);
  let sumXY = points.reduce((a,b)=>a+b.x*b.y,0);
  let sumX2 = points.reduce((a,b)=>a+b.x*b.x,0);
  let denom = n*sumX2 - sumX*sumX;
  if(Math.abs(denom)<1e-12) return null;
  let slope = (n*sumXY - sumX*sumY) / denom;
  let intercept = (sumY - slope*sumX) / n;
  return { slope, intercept };
}

function computeCalibrations(){
  let out={};
  TOXINS.forEach(t=>{
    let pts = standards[t]
      .map(p=>({ x: parseFloat(p.area)||0, y: parseFloat(p.conc)||0 }))
      .filter(p=>p.x>0);
    out[t] = linearRegression(pts);
  });
  return out;
}

function predict(toxin, area, calibrations){
  let c = calibrations[toxin];
  if(!c) return 0;
  let x = parseFloat(area)||0;
  return c.slope * x + c.intercept;
}

function matchPeaks(peaks){
  let refRT={};
  TOXINS.forEach(t=>{
    let rts = standards[t]
      .map(s=>parseFloat(s.rt)||NaN)
      .filter(v=>!isNaN(v));
    if(rts.length) refRT[t] = rts.reduce((a,b)=>a+b)/rts.length;
  });

  return peaks.map(p=>{
    let rt = parseFloat(p.rt);
    if(isNaN(rt)) return { ...p, matched:null };
    let best=null, diff=999;
    for(const t in refRT){
      let d = Math.abs(refRT[t]-rt);
      if(d <= rtTolerance && d < diff){ best=t; diff=d; }
    }
    return { ...p, matched:best };
  });
}

function computeSample(s, calibrations){
  let m = matchPeaks(s.peaks);
  let perToxin={}; TOXINS.forEach(t=>perToxin[t]=0);
  m.forEach(p=>{
    if(p.matched){ perToxin[p.matched] += predict(p.matched, p.area, calibrations); }
  });
  let total = TOXINS.reduce((a,t)=>a+perToxin[t],0);
  let corrected = (total * dilution) / sampleWeight;
  return { perToxin, total, corrected };
}

// ---------------------------
// RENDER UI
// ---------------------------
function render(){
  const root = document.getElementById("app");
  root.innerHTML = `
    <div class="card">
      <h2>Standards (B1/B2/G1/G2)</h2>
      ${TOXINS.map(t=>`
        <div class="card">
          <h3>${t}</h3>
          ${standards[t].map(row=>`
            <div class="flex">
              <input value="${row.conc}" onchange="updateStandard('${t}',${row.id},'conc',this.value)" placeholder="conc" />
              <input value="${row.area}" onchange="updateStandard('${t}',${row.id},'area',this.value)" placeholder="area" />
              <input value="${row.rt}" onchange="updateStandard('${t}',${row.id},'rt',this.value)" placeholder="RT" />
              <button class="btn" onclick="removeStd('${t}',${row.id})">×</button>
            </div>
          `).join('')}
          <button class="btn" onclick="addStd('${t}')">Add</button>
        </div>
      `).join('')}
    </div>

    <div class="card">
      <h2>Samples & Peaks</h2>
      ${samples.map(s=>`
        <div class="card">
          <input value="${s.name}" onchange="renameSample(${s.id},this.value)" />
          ${s.peaks.map(p=>`
            <div class="flex">
              <input value="${p.rt}" onchange="updatePeak(${s.id},${p.id},'rt',this.value)" placeholder="RT" />
              <input value="${p.area}" onchange="updatePeak(${s.id},${p.id},'area',this.value)" placeholder="Area" />
              <button class="btn" onclick="delPeak(${s.id},${p.id})">×</button>
            </div>
          `).join('')}
          <button class="btn" onclick="addPeak(${s.id})">Add Peak</button>
        </div>
      `).join('')}
      <button class="btn" onclick="addSample()">Add Sample</button>
    </div>

    <div class="card">
      <h2>Settings</h2>
      <div class="flex">
        <input value="${dilution}" onchange="dilution=this.value; render()" placeholder="Dilution" />
        <input value="${sampleWeight}" onchange="sampleWeight=this.value; render()" placeholder="Sample weight" />
        <input value="${rtTolerance}" onchange="rtTolerance=this.value; render()" placeholder="RT tolerance" />
      </div>
    </div>

    <div class="card">
      <h2>Results</h2>
      ${renderResults()}
    </div>
  `;
}

// ---------------------------
// UPDATE FUNCTIONS
// ---------------------------
function updateStandard(t,id,field,val){ standards[t] = standards[t].map(r=>r.id===id?{...r,[field]:val}:r); render(); }
function addStd(t){ standards[t].push({id:id(),conc:"",area:"",rt:""}); render(); }
function removeStd(t,id){ standards[t]=standards[t].filter(r=>r.id!==id); render(); }

function addSample(){ samples.push({id:id(),name:"New Sample",peaks:[]}); render(); }
function renameSample(id,val){ samples = samples.map(s=>s.id===id?{...s,name:val}:s); render(); }
function addPeak(sampleId){ samples = samples.map(s=>s.id===sampleId?{...s,peaks:[...s.peaks,{id:id(),rt:"",area:""}]}:s); render(); }
function updatePeak(sampleId,peakId,field,val){ samples = samples.map(s=>{
  if(s.id!==sampleId) return s;
  return {...s,peaks:s.peaks.map(p=>p.id===peakId?{...p,[field]:val}:p)};
}); render(); }
function delPeak(sampleId,peakId){ samples=samples.map(s=>s.id===sampleId?{...s,peaks:s.peaks.filter(p=>p.id!==peakId)}:s); render(); }

// ---------------------------
// RESULTS TABLE
// ---------------------------
function renderResults(){
  let cal = computeCalibrations();
  let rows = samples.map(s=>{
    let r = computeSample(s,cal);
    return `
      <tr>
        <td>${s.name}</td>
        ${TOXINS.map(t=>`<td>${r.perToxin[t].toFixed(3)}</td>`).join('')}
        <td>${r.total.toFixed(3)}</td>
        <td>${r.corrected.toFixed(3)}</td>
      </tr>
    `;
  }).join('');

  return `
    <table>
      <thead>
        <tr><th>Sample</th>${TOXINS.map(t=>`<th>${t}</th>`).join('')}<th>Total</th><th>Corrected</th></tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}

// ---------------------------
// START
// ---------------------------
render();
</script>
</body>
</html>
